<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Santa's Little Helper</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Santa Game">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a1a3c;
            --text-color: #ffffff;
            /* Unified Christmas color palette */
            --red-primary: #c0392b;
            --red-light: #e74c3c;
            --green-primary: #27ae60;
            --green-light: #2ecc71;
            --blue-primary: #2980b9;
            --blue-light: #3498db;
            --gold: #f1c40f;
            --silver: #ecf0f1;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Fredoka One', cursive;
            color: var(--text-color);
        }

        /* --- Aurora & Snowfall Effect --- */
        #sky-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            z-index: 0;
        }

        #moon {
            position: absolute;
            top: 5%;
            right: 10%;
            width: 120px;
            height: 120px;
            z-index: 0;
            filter: drop-shadow(0 0 15px rgba(241, 196, 15, 0.5));
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        #aurora {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background:
                linear-gradient(90deg, transparent 0%, rgba(50, 255, 100, 0.1) 20%, rgba(0, 255, 255, 0.1) 50%, rgba(50, 255, 100, 0.1) 80%, transparent 100%);
            filter: blur(40px);
            animation: aurora-shift 20s infinite alternate;
            z-index: 0;
            opacity: 0.5;
        }

        @keyframes aurora-shift {
            0% {
                transform: translateX(-10%) skewX(-10deg);
            }

            100% {
                transform: translateX(10%) skewX(10deg);
            }
        }

        .snowflake {
            position: absolute;
            top: -10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(360deg);
            }
        }

        /* --- Layout --- */
        #game-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            z-index: 2;
        }

        /* TV View (Top 60%) */
        #tv-view {
            flex: 60;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Scoreboard */
        #scoreboard-container {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 10;
        }

        #level-display {
            font-size: 1.8rem;
            color: #f1c40f;
            margin-bottom: 5px;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }

        #scoreboard {
            font-size: 2.5rem;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
        }

        #status-text {
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s;
            letter-spacing: 1px;
        }

        #combo-display {
            position: absolute;
            top: 80px;
            left: 30px;
            font-size: 1.5rem;
            color: #f39c12;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s;
        }

        #mode-indicator {
            position: absolute;
            bottom: 20px;
            left: 30px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        /* Santa & Bubble */
        #santa-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(10px);
            height: 100%;
            /* Ensure container respects parent height */
        }

        #santa-svg {
            width: auto;
            height: auto;
            max-height: 50vh;
            /* Limit height on mobile landscape */
            max-width: 250px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            transition: transform 0.5s;
            z-index: 5;
            animation: santa-breathe 3s ease-in-out infinite;
        }

        /* ... keyframes ... */

        #bubble {
            position: absolute;
            left: 75%;
            /* Move closer to center */
            top: 0%;
            /* Move down from -30% */
            background: white;
            border-radius: 50%;
            padding: 10px;
            width: 90px;
            /* Slightly smaller */
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 6;
        }

        #bubble.show {
            transform: scale(1);
        }

        #bubble::after {
            content: '';
            position: absolute;
            left: -15px;
            top: 60%;
            border: 12px solid transparent;
            border-right-color: white;
            transform: translateY(-50%) rotate(-10deg);
        }

        .prompt-content {
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
        }

        .color-prompt {
            border-radius: 50%;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.1);
        }

        /* Controls View (Bottom 40%) - Glassmorphism */
        #controls-view {
            flex: 40;
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 0;
            align-items: flex-end;
            justify-content: space-around;
            padding-bottom: 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
        }

        .control-btn {
            flex: 1;
            height: 100%;
            border: none;
            outline: none;
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
            padding: 0;
            max-width: 30%;
        }

        .control-btn:active {
            transform: scale(0.95) translateY(5px);
        }

        .control-btn.active-hint {
            transform: translateY(-10px);
        }

        .control-btn.active-hint .control-content {
            filter: drop-shadow(0 0 15px gold) brightness(1.2);
        }

        .control-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
            transition: filter 0.2s;
        }

        /* --- Overlays --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 26, 60, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        #orientation-overlay {
            display: none;
            background: #e74c3c;
        }

        #start-overlay {
            cursor: pointer;
            background: radial-gradient(circle at center, #1a2a6c, #0a1a3c);
        }

        /* Mode Selection Screen */
        #mode-select-overlay {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .mode-options {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }

        .mode-option {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            border: 2px solid transparent;
            min-width: 200px;
        }

        .mode-option:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.25);
            border-color: #f1c40f;
        }

        .mode-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .mode-title {
            font-size: 1.5rem;
            margin: 10px 0;
        }

        .mode-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #level-up-overlay {
            display: none;
            background: rgba(0, 0, 0, 0.85);
            pointer-events: none;
        }

        #level-up-overlay.show {
            display: flex;
            animation: fadeIn 0.5s;
        }

        .overlay-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        h1 {
            font-size: 3rem;
            margin: 0;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        p {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* --- Animations --- */
        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-10px) rotate(-5deg);
            }

            40% {
                transform: translateX(10px) rotate(5deg);
            }

            60% {
                transform: translateX(-10px) rotate(-5deg);
            }

            80% {
                transform: translateX(10px) rotate(5deg);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .pop {
            animation: pop 0.3s ease-out;
        }

        @keyframes fly-gift {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 1;
            }

            50% {
                transform: translate(0, -30vh) scale(1.2) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: translate(0, -60vh) scale(0.5) rotate(360deg);
                opacity: 0;
            }
        }

        .flying-gift {
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: 50;
            pointer-events: none;
            animation: fly-gift 1s ease-out forwards;
        }

        @keyframes fireworks {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes sparkle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            z-index: 60;
            animation: sparkle 0.6s ease-out forwards;
            box-shadow: 0 0 10px gold;
        }

        /* Combo Mode Styles */
        .combo-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .combo-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .combo-item-emoji {
            font-size: 2.5rem;
        }

        .combo-item-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #combo-step-indicator {
            position: absolute;
            top: 140px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        #combo-step-indicator.show {
            opacity: 1;
        }

        .controls-grid {
            display: grid;
            gap: 10px;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .controls-grid.grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        .controls-grid.grid-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        .controls-grid .control-btn {
            max-width: none;
            height: auto;
            aspect-ratio: 1;
            font-size: 3rem;
            /* Default size */
        }

        .control-btn.animal-btn {
            font-size: 6rem;
            /* Larger for animals */
        }

        @media screen and (orientation: landscape) and (max-height: 800px) {
            #tv-view {
                flex: 40;
                /* Even smaller top section */
                align-items: flex-end;
                padding-bottom: 2px;
            }

            #controls-view {
                flex: 60;
                /* More space for controls */
                padding-bottom: 5px;
                display: flex;
                align-items: center;
                /* Center vertically */
            }

            .controls-grid {
                padding: 2px 10px;
                gap: 5px;
                /* Tighter gap */
                transform: scale(0.95);
                /* Slight scale down to be safe */
                transform-origin: center center;
            }

            #santa-svg,
            #character-img {
                max-height: 30vh !important;
                /* Even smaller */
                max-width: 180px !important;
            }

            #bubble {
                width: 60px;
                height: 60px;
                left: 60%;
                top: -10%;
                /* Move up slightly */
                padding: 5px;
            }

            .prompt-content {
                font-size: 1.8rem;
            }

            #status-text {
                font-size: 1rem;
                top: 5px;
                left: 10px;
            }

            #combo-display {
                font-size: 0.9rem;
                top: 25px;
                left: 10px;
            }

            #combo-step-indicator {
                top: 50px;
                /* Move up */
                font-size: 0.9rem;
                width: 100%;
                text-align: center;
                left: 0;
                transform: none;
                padding: 0;
                background: transparent;
                backdrop-filter: none;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
                /* Ensure readability */
                z-index: 20;
            }

            #mode-indicator {
                display: none;
                /* Hide mode indicator on small screens to save space */
            }

            #scoreboard-container {
                transform: scale(0.6);
                transform-origin: top right;
                top: 5px;
                right: 10px;
            }

            .controls-grid.grid-6 {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: 1fr;
            }

            .controls-grid .control-btn {
                max-width: none;
                height: 100%;
                aspect-ratio: auto;
                /* Remove square constraint */
                padding: 5px;
            }

            .controls-grid .control-content>div:first-child {
                width: 40px !important;
                height: 40px !important;
                font-size: 2rem !important;
                /* Smaller emoji */
            }

            .controls-grid .control-content>div:last-child {
                font-size: 0.7rem !important;
                /* Smaller text */
                display: none;
                /* Hide text label if needed to save space */
            }

            #santa-container {
                transform: translateY(0);
            }
        }

        @media screen and (orientation: portrait) {
            #orientation-overlay {
                display: flex !important;
            }

            #game-container,
            #start-overlay,
            #mode-select-overlay {
                display: none !important;
            }

            /* Replay Button */
            #replay-btn {
                position: absolute;
                top: 15px;
                left: 15px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #f39c12;
                /* Orange cartoonish color */
                border: 3px solid #fff;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                color: white;
                font-size: 2rem;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                z-index: 30;
                transition: transform 0.2s;
            }

            #replay-btn:active {
                transform: scale(0.9);
            }

            /* Turn Signal (Green Light) */
            #turn-signal {
                position: absolute;
                top: 15px;
                left: 90px;
                /* Next to replay button */
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #333;
                border: 4px solid #555;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                z-index: 20;
                display: flex;
                justify-content: center;
                align-items: center;
                transition: all 0.3s;
                opacity: 0.5;
                /* Dim when off */
            }

            #turn-signal.active {
                background: #2ecc71;
                /* Green */
                border-color: #27ae60;
                box-shadow: 0 0 30px #2ecc71, inset 0 0 20px rgba(255, 255, 255, 0.5);
                transform: scale(1.1);
                opacity: 1;
            }

            #turn-signal::after {
                content: 'GO';
                font-size: 1.2rem;
                font-weight: bold;
                color: rgba(255, 255, 255, 0.3);
            }

            #turn-signal.active::after {
                color: white;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            }

            #scoreboard-container {
                position: absolute;
                top: 20px;
                right: 20px;
                text-align: right;
                background: transparent;
                /* Remove background */
                padding: 10px;
                border-radius: 15px;
                /* backdrop-filter: blur(5px); Removed to fix "weird box" look */
            }
    </style>
</head>

<body>

    <div id="sky-bg"></div>
    <div id="moon">
        <svg viewBox="0 0 100 100" width="100%" height="100%" style="overflow: visible;">
            <!-- Crescent Moon Shape -->
            <path d="M75 15 A 45 45 0 1 1 45 95 A 35 35 0 1 0 75 15 Z" fill="#f1c40f" />
            <!-- Sleeping Eye -->
            <path d="M45 50 Q 55 55 65 50" fill="none" stroke="#d35400" stroke-width="3" stroke-linecap="round"
                opacity="0.6" />
            <!-- Zzz Animation -->
            <g>
                <text x="80" y="30" font-family="Fredoka One" font-size="16" fill="#fff" opacity="0.9"
                    style="animation: zzz 3s infinite">Z</text>
                <text x="95" y="15" font-family="Fredoka One" font-size="12" fill="#fff" opacity="0.7"
                    style="animation: zzz 3s 1s infinite">z</text>
            </g>
        </svg>
        <style>
            @keyframes zzz {
                0% {
                    transform: translate(0, 0);
                    opacity: 0;
                }

                50% {
                    opacity: 1;
                }

                100% {
                    transform: translate(10px, -10px);
                    opacity: 0;
                }
            }
        </style>
    </div>
    <div id="aurora"></div>

    <div id="debug-controls">
        <div class="debug-btn">v2.1</div>
        <button class="debug-btn" onclick="forceReload()">ğŸ”„ Fix/Reload</button>
    </div>

    <div id="orientation-overlay">
        <div class="overlay-icon">ğŸ“±â¡ï¸</div>
        <h1>è«‹å°‡æ‰‹æ©Ÿè½‰æ©«</h1>
        <p>Please Rotate Your Device</p>
    </div>

    <div id="start-overlay">
        <svg width="120" height="120" viewBox="0 0 100 100" class="overlay-icon">
            <circle cx="50" cy="50" r="45" fill="#e74c3c" />
            <circle cx="50" cy="40" r="20" fill="#f1c40f" />
            <path d="M30 50 Q50 80 70 50" fill="#ecf0f1" />
            <circle cx="43" cy="35" r="3" fill="#333" />
            <circle cx="57" cy="35" r="3" fill="#333" />
            <circle cx="50" cy="42" r="4" fill="#e74c3c" opacity="0.5" />
            <path d="M20 30 Q50 5 80 30" fill="#e74c3c" stroke="white" stroke-width="5" />
            <circle cx="80" cy="30" r="8" fill="white" />
        </svg>
        <h1>è–èª•å°å¹«æ‰‹</h1>
        <p>Santa's Little Helper</p>
        <p style="font-size: 0.8rem; margin-top: 20px; opacity: 0.7;">ğŸ”Š é»æ“Šé–‹å§‹</p>
    </div>

    <!-- Character Selection Overlay -->
    <div id="character-select-overlay" class="overlay" style="display: none;">
        <h1>é¸æ“‡è§’è‰²</h1>
        <p>Choose Your Character</p>
        <div class="mode-options">
            <div class="mode-option" data-character="santa">
                <img src="./å¤–éƒ¨è³‡æº/è–èª•è€äºº.png"
                    style="width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px;">
                <div class="mode-title">è–èª•è€äºº</div>
                <div class="mode-desc">Santa</div>
            </div>
            <div class="mode-option" data-character="snowman">
                <img src="./å¤–éƒ¨è³‡æº/é›ªäºº.png" style="width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px;">
                <div class="mode-title">é›ªäºº</div>
                <div class="mode-desc">Snowman</div>
            </div>
            <div class="mode-option" data-character="reindeer">
                <img src="./å¤–éƒ¨è³‡æº/é¦´é¹¿.png" style="width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px;">
                <div class="mode-title">é¦´é¹¿</div>
                <div class="mode-desc">Reindeer</div>
            </div>
        </div>
    </div>

    <!-- Mode Selection Overlay -->
    <div id="mode-select-overlay" class="overlay" style="display: none;">
        <h1>é¸æ“‡éŠæˆ²æ¨¡å¼</h1>
        <p>Choose Your Game Mode</p>
        <div class="mode-options">
            <div class="mode-option" data-mode="color">
                <div class="mode-icon">ğŸ¨</div>
                <div class="mode-title">é¡è‰²é…å°</div>
                <div class="mode-desc">Colors</div>
            </div>
            <div class="mode-option" data-mode="shape">
                <div class="mode-icon">ğŸ”·</div>
                <div class="mode-title">å½¢ç‹€é…å°</div>
                <div class="mode-desc">Shapes</div>
            </div>
            <div class="mode-option" data-mode="pitch">
                <div class="mode-icon">ğŸµ</div>
                <div class="mode-title">éŸ³é«˜é…å°</div>
                <div class="mode-desc">Musical Notes</div>
            </div>
            <div class="mode-option" data-mode="combo">
                <div class="mode-icon">ğŸ¯</div>
                <div class="mode-title">çµ„åˆæŒ‘æˆ°</div>
                <div class="mode-desc">Numbers, Colors & Animals</div>
            </div>
        </div>
    </div>

    <div id="level-up-overlay" class="overlay">
        <div class="overlay-icon">ğŸš€</div>
        <h1 id="level-up-text">Level Up!</h1>
    </div>

    <!-- Audio Players for Real Music -->
    <audio id="bgm-player" loop style="display: none;">
        <source src="./å¤–éƒ¨è³‡æº/jingle-bells.mp3" type="audio/mpeg">
        <source src="./å¤–éƒ¨è³‡æº/silent-night.mp3" type="audio/mpeg">
    </audio>

    <div id="game-container">
        <div id="tv-view">
            <div id="snow-container"></div>

            <button id="replay-btn" onclick="replaySequence()">ğŸ”Š</button>
            <div id="turn-signal"></div>

            <div id="status-text" style="left: 80px;">Listen...</div> <!-- Shifted right -->
            <div id="combo-display">ğŸ”¥ Combo: 0</div>

            <!-- Next Level Button -->
            <button id="next-level-btn" onclick="nextLevel()"
                style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; padding: 15px 30px; background: #2ecc71; color: white; border: 4px solid #fff; border-radius: 50px; cursor: pointer; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                Next Level â¡ï¸
            </button>

            <div id="combo-step-indicator">Step 1/3: Choose number</div>
            <div id="mode-indicator">ğŸ¨ Colors</div>
            <div id="scoreboard-container">
                <div id="level-display">Level 1</div>
                <div id="scoreboard">â˜†â˜†â˜†â˜†â˜†</div>
            </div>

            <div id="santa-container">
                <img id="character-img" src="./å¤–éƒ¨è³‡æº/è–èª•è€äºº.png" alt="Character"
                    style="width: auto; height: auto; max-height: 50vh; max-width: 300px; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3)); animation: santa-breathe 3s ease-in-out infinite;">

                <div id="bubble">
                    <div id="bubble-content" class="prompt-content"></div>
                </div>
            </div>
        </div>

        <div id="controls-view">
            <!-- Buttons will be dynamically created based on mode -->
        </div>
    </div>

    <script>
        const GAME_MODES = {
            color: {
                name: 'Colors',
                icon: 'ğŸ¨',
                items: ['red', 'green', 'blue', 'yellow', 'purple', 'orange'],
                display: {
                    red: { color: '#c0392b', emoji: 'ğŸ' },
                    green: { color: '#27ae60', emoji: 'ğŸ' },
                    blue: { color: '#2980b9', emoji: 'ğŸ' },
                    yellow: { color: '#f1c40f', emoji: 'ğŸ' },
                    purple: { color: '#8e44ad', emoji: 'ğŸ' },
                    orange: { color: '#e67e22', emoji: 'ğŸ' }
                }
            },
            shape: {
                name: 'Shapes',
                icon: 'ğŸ”·',
                items: ['circle', 'square', 'triangle'],
                display: {
                    circle: { shape: 'circle', color: '#e74c3c' },
                    square: { shape: 'square', color: '#2ecc71' },
                    triangle: { shape: 'triangle', color: '#3498db' }
                }
            },
            pitch: {
                name: 'Pitches',
                icon: 'ğŸµ',
                items: ['low', 'mid', 'high'],
                display: {
                    low: { note: 'â™©', color: '#e74c3c', freq: 261.63 },
                    mid: { note: 'â™ª', color: '#f39c12', freq: 329.63 },
                    high: { note: 'â™«', color: '#3498db', freq: 392.00 }
                }
            },
            combo: {
                name: 'Combo Challenge',
                icon: 'ğŸ¯',
                numbers: [
                    { value: 1, name: 'one', emoji: '1ï¸âƒ£', color: '#e74c3c' },
                    { value: 2, name: 'two', emoji: '2ï¸âƒ£', color: '#3498db' },
                    { value: 3, name: 'three', emoji: '3ï¸âƒ£', color: '#2ecc71' },
                    { value: 4, name: 'four', emoji: '4ï¸âƒ£', color: '#f39c12' },
                    { value: 5, name: 'five', emoji: '5ï¸âƒ£', color: '#9b59b6' }
                ],
                colors: [
                    { name: 'red', color: '#c0392b', emoji: 'ğŸ”´' },
                    { name: 'green', color: '#27ae60', emoji: 'ğŸŸ¢' },
                    { name: 'blue', color: '#2980b9', emoji: 'ğŸ”µ' },
                    { name: 'yellow', color: '#f1c40f', emoji: 'ğŸŸ¡' },
                    { name: 'purple', color: '#8e44ad', emoji: 'ğŸŸ£' },
                    { name: 'orange', color: '#e67e22', emoji: 'ğŸŸ ' }
                ],
                animals: [
                    { name: 'crab', emoji: 'ğŸ¦€', plural: 'crabs' },
                    { name: 'fish', emoji: 'ğŸŸ', plural: 'fish' },
                    { name: 'bird', emoji: 'ğŸ¦', plural: 'birds' },
                    { name: 'cat', emoji: 'ğŸ±', plural: 'cats' },
                    { name: 'dog', emoji: 'ğŸ¶', plural: 'dogs' },
                    { name: 'rabbit', emoji: 'ğŸ°', plural: 'rabbits' },
                    { name: 'panda', emoji: 'ğŸ¼', plural: 'pandas' },
                    { name: 'frog', emoji: 'ğŸ¸', plural: 'frogs' },
                    { name: 'elephant', emoji: 'ğŸ˜', plural: 'elephants' },
                    { name: 'lion', emoji: 'ğŸ¦', plural: 'lions' },
                    { name: 'tiger', emoji: 'ğŸ¯', plural: 'tigers' },
                    { name: 'monkey', emoji: 'ğŸµ', plural: 'monkeys' },
                    { name: 'pig', emoji: 'ğŸ·', plural: 'pigs' },
                    { name: 'cow', emoji: 'ğŸ®', plural: 'cows' },
                    { name: 'sheep', emoji: 'ğŸ‘', plural: 'sheep' },
                    { name: 'horse', emoji: 'ğŸ´', plural: 'horses' },
                    { name: 'duck', emoji: 'ğŸ¦†', plural: 'ducks' },
                    { name: 'chicken', emoji: 'ğŸ”', plural: 'chickens' }
                ]
            }
        };

        const audioSys = {
            ctx: null,
            synth: window.speechSynthesis,
            currentSong: 0,
            bellInterval: null,
            voice: null,

            songs: [
                // Jingle Bells
                [
                    { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.4 },
                    { f: 0, d: 0.2 },
                    { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.4 },
                    { f: 0, d: 0.2 },
                    { f: 329.63, d: 0.2 }, { f: 392.00, d: 0.2 }, { f: 261.63, d: 0.3 }, { f: 293.66, d: 0.2 }, { f: 329.63, d: 0.6 },
                    { f: 0, d: 0.4 },
                    { f: 349.23, d: 0.2 }, { f: 349.23, d: 0.2 }, { f: 349.23, d: 0.2 }, { f: 349.23, d: 0.2 },
                    { f: 349.23, d: 0.2 }, { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.2 }, { f: 329.63, d: 0.2 },
                    { f: 329.63, d: 0.2 }, { f: 293.66, d: 0.2 }, { f: 293.66, d: 0.2 }, { f: 329.63, d: 0.2 },
                    { f: 293.66, d: 0.4 }, { f: 392.00, d: 0.4 }
                ],
                // Silent Night (simplified)
                [
                    { f: 392.00, d: 0.6 }, { f: 440.00, d: 0.3 }, { f: 392.00, d: 0.3 },
                    { f: 329.63, d: 0.9 }, { f: 0, d: 0.3 },
                    { f: 392.00, d: 0.6 }, { f: 440.00, d: 0.3 }, { f: 392.00, d: 0.3 },
                    { f: 329.63, d: 0.9 }, { f: 0, d: 0.3 },
                    { f: 523.25, d: 0.6 }, { f: 523.25, d: 0.3 }, { f: 466.16, d: 0.3 },
                    { f: 392.00, d: 0.9 }, { f: 0, d: 0.3 },
                    { f: 440.00, d: 0.6 }, { f: 440.00, d: 0.3 }, { f: 392.00, d: 0.3 },
                    { f: 329.63, d: 1.2 }
                ]
            ],

            init: function () {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                // Procedural BGM removed - using real MP3 music instead
                this.startBellSound();

                // Init voices
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => this.setVoice();
                }
                this.setVoice();
            },

            setVoice: function () {
                const voices = this.synth.getVoices();
                // Prefer a female/default English voice
                // "Google US English" is often female. "Samantha" is female.
                this.voice = voices.find(v => v.lang.includes('en') && (v.name.includes('Female') || v.name.includes('Samantha') || v.name.includes('Google US English'))) ||
                    voices.find(v => v.lang.includes('en'));

                console.log("Selected voice:", this.voice ? this.voice.name : "Default");
            },

            playToneADSR: function (freq, duration, type = 'sine', vol = 0.2) {
                if (!this.ctx) return;

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(freq * 2, this.ctx.currentTime);

                const attack = 0.02;
                const decay = 0.1;
                const sustain = vol * 0.7;
                const release = 0.2;

                const now = this.ctx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(vol, now + attack);
                gain.gain.linearRampToValueAtTime(sustain, now + attack + decay);
                gain.gain.setValueAtTime(sustain, now + duration - release);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start(now);
                osc.stop(now + duration);
            },



            startBellSound: function () {
                this.bellInterval = setInterval(() => {
                    if (state.isPlaying && Math.random() > 0.8) {
                        this.playToneADSR(1046.50, 0.1, 'triangle', 0.03);
                    }
                }, 5000);
            },

            speak: function (text, lang = 'en-US') {
                if (this.synth.speaking) {
                    this.synth.cancel();
                }
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = lang;
                if (this.voice) utter.voice = this.voice;

                utter.rate = 0.7; // Slower
                utter.pitch = 1.1; // Slightly higher but natural female pitch

                this.synth.speak(utter);
            },

            playItem: function (item) {
                const mode = state.currentMode;
                if (mode === 'pitch') {
                    const freq = GAME_MODES.pitch.display[item].freq;
                    this.playToneADSR(freq, 0.5, 'triangle', 0.3);
                } else if (mode === 'color') {
                    const freqs = {
                        'red': 261.63,    // C4
                        'green': 293.66,  // D4
                        'blue': 329.63,   // E4
                        'yellow': 349.23, // F4
                        'purple': 392.00, // G4
                        'orange': 440.00  // A4
                    };
                    this.playToneADSR(freqs[item], 0.3, 'triangle', 0.25);
                } else if (mode === 'shape') {
                    const freqs = { 'circle': 261.63, 'square': 329.63, 'triangle': 392.00 };
                    this.playToneADSR(freqs[item], 0.3, 'triangle', 0.25);
                }

                if (mode !== 'pitch') {
                    setTimeout(() => this.speak(item), 100);
                }
            },

            playCorrect: function () {
                // Ding-Dong sound
                const now = this.ctx.currentTime;
                this.playToneADSR(659.25, 0.1, 'sine', 0.3); // E5
                setTimeout(() => this.playToneADSR(830.61, 0.4, 'sine', 0.3), 100); // G#5
            },

            playWrong: function () {
                this.playToneADSR(150, 0.4, 'sawtooth', 0.2);
                this.speak("Oops!");
            },

            playCombo: function (numberObj, colorObj, animalObj) {
                // Determine singular or plural form
                const animalName = numberObj.value === 1 ? animalObj.name : animalObj.plural;
                const phrase = `${numberObj.name} ${colorObj.name} ${animalName}`;

                // Play a pleasant tone
                this.playToneADSR(392.00, 0.3, 'triangle', 0.2);

                // Speak the full phrase
                setTimeout(() => this.speak(phrase), 100);
            },

            playWin: function () {
                // Victory Fanfare!
                const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50]; // C E G C G C
                const times = [0, 150, 300, 450, 600, 800];
                const durations = [0.15, 0.15, 0.15, 0.15, 0.2, 0.6];

                notes.forEach((f, i) => {
                    setTimeout(() => this.playToneADSR(f, durations[i], 'square', 0.2), times[i]);
                });
                setTimeout(() => this.speak("Amazing!"), 1000);
            }
        };

        const achievements = {
            totalStars: 0,
            combo: 0,
            bestCombo: 0,

            load: function () {
                const saved = localStorage.getItem('santaGameAchievements');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.totalStars = data.totalStars || 0;
                    this.bestCombo = data.bestCombo || 0;
                }
            },

            save: function () {
                localStorage.setItem('santaGameAchievements', JSON.stringify({
                    totalStars: this.totalStars,
                    bestCombo: this.bestCombo
                }));
            },

            addStar: function () {
                this.totalStars++;
                this.combo++;
                if (this.combo > this.bestCombo) {
                    this.bestCombo = this.combo;
                }
                this.save();
                this.updateUI();
            },

            breakCombo: function () {
                this.combo = 0;
                this.updateUI();
            },

            updateUI: function () {
                const comboDisplay = document.getElementById('combo-display');
                if (this.combo >= 3) {
                    comboDisplay.textContent = `ğŸ”¥ Combo: ${this.combo}x`;
                    comboDisplay.style.opacity = 1;
                } else {
                    comboDisplay.style.opacity = 0;
                }
            }
        };

        const santaAnim = {
            init: function () {
                // PNG images don't have SVG eyes to animate
                // Character animation is handled by CSS (santa-breathe)
                console.log('Character animation initialized');
            },

            nod: function () {
                // Apply nod effect to the character image
                const characterImg = document.getElementById('character-img');
                if (characterImg) {
                    characterImg.style.animation = 'none';
                    setTimeout(() => {
                        characterImg.style.animation = 'santa-breathe 3s ease-in-out infinite, nod 0.5s';
                    }, 10);
                    setTimeout(() => {
                        characterImg.style.animation = 'santa-breathe 3s ease-in-out infinite';
                    }, 600);
                }
            }
        };

        let state = {
            currentMode: 'color',
            score: 0,
            maxScore: 5,
            level: 1,
            sequence: [],
            playerInputIndex: 0,
            isInputLocked: false,
            isPlaying: false,
            // Combo mode specific
            comboSequence: [],  // [{number, color, animal}, ...]
            comboStep: 0,  // 0=number, 1=color, 2=animal
            currentComboSelection: {}  // Temporary storage for current combo being selected
        };

        const ui = {
            startOverlay: document.getElementById('start-overlay'),
            modeSelectOverlay: document.getElementById('mode-select-overlay'),
            levelUpOverlay: document.getElementById('level-up-overlay'),
            levelUpText: document.getElementById('level-up-text'),
            gameContainer: document.getElementById('game-container'),
            scoreboard: document.getElementById('scoreboard'),
            levelDisplay: document.getElementById('level-display'),
            statusText: document.getElementById('status-text'),
            comboDisplay: document.getElementById('combo-display'),
            modeIndicator: document.getElementById('mode-indicator'),
            bubble: document.getElementById('bubble'),
            bubbleContent: document.getElementById('bubble-content'),
            controlsView: document.getElementById('controls-view'),
            snowContainer: document.getElementById('snow-container')
        };

        let selectedCharacter = 'santa';
        const bgmPlayer = document.getElementById('bgm-player');
        const characterImg = document.getElementById('character-img');

        function applyCharacterEffect(character) {
            const body = document.body;
            body.classList.remove('santa-effect', 'snowman-effect', 'reindeer-effect'); // Clear previous effects

            switch (character) {
                case 'santa':
                    body.classList.add('santa-effect');
                    break;
                case 'snowman':
                    body.classList.add('snowman-effect');
                    break;
                case 'reindeer':
                    body.classList.add('reindeer-effect');
                    break;
                default:
                    break;
            }
        }

        function init() {
            createSnow();
            achievements.load();

            ui.startOverlay.addEventListener('click', showCharacterSelect);

            // Character selection
            document.querySelectorAll('[data-character]').forEach(option => {
                option.addEventListener('click', () => {
                    selectedCharacter = option.getAttribute('data-character');
                    // Map English names to Chinese filenames
                    const characterFiles = {
                        'santa': 'è–èª•è€äºº.png',
                        'snowman': 'é›ªäºº.png',
                        'reindeer': 'é¦´é¹¿.png'
                    };
                    if (characterImg) {
                        characterImg.src = `./å¤–éƒ¨è³‡æº/${characterFiles[selectedCharacter]}`;
                        // Apply character-specific visual effect
                        applyCharacterEffect(selectedCharacter);
                    }
                    showModeSelect();
                });
            });

            // Mode selection
            document.querySelectorAll('[data-mode]').forEach(option => {
                option.addEventListener('click', () => {
                    const mode = option.getAttribute('data-mode');
                    startGame(mode);
                });
            });
        }

        function showCharacterSelect() {
            ui.startOverlay.style.display = 'none';
            document.getElementById('character-select-overlay').style.display = 'flex';
        }

        function showModeSelect() {
            document.getElementById('character-select-overlay').style.display = 'none';
            ui.modeSelectOverlay.style.display = 'flex';
        }

        function startGame(mode) {
            state.currentMode = mode;
            state.isPlaying = true;

            // Start real music
            if (bgmPlayer) {
                bgmPlayer.volume = 0.3;
                bgmPlayer.play().catch(e => console.log('Audio play failed:', e));
            }

            audioSys.init();
            santaAnim.init();
            audioSys.speak("Let's play!");

            ui.modeSelectOverlay.style.display = 'none';
            ui.gameContainer.style.display = 'flex';

            const modeConfig = GAME_MODES[mode];
            ui.modeIndicator.textContent = `${modeConfig.icon} ${modeConfig.name}`;

            createControls(mode);

            state.score = 0;
            state.level = 1;
            updateScoreboard();

            setTimeout(startRound, 1000);
        }

        function createControls(mode) {
            ui.controlsView.innerHTML = '';

            if (mode === 'combo') {
                // Combo mode uses special grid layout
                const grid = document.createElement('div');
                grid.className = 'controls-grid';
                ui.controlsView.appendChild(grid);
                updateComboControls(0);  // Start with numbers
            } else {
                // Other modes use original flex layout
                const modeConfig = GAME_MODES[mode];

                modeConfig.items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'control-btn';
                    btn.setAttribute('data-item', item);

                    const content = document.createElement('div');
                    content.className = 'control-content';

                    if (mode === 'color') {
                        content.innerHTML = createChimneySVG(item);
                    } else if (mode === 'shape') {
                        content.innerHTML = createShapeSVG(item);
                    } else if (mode === 'pitch') {
                        content.innerHTML = createPitchSVG(item);
                    }

                    btn.appendChild(content);
                    ui.controlsView.appendChild(btn);

                    const handler = (e) => {
                        e.preventDefault();
                        handleInput(item);
                    };
                    btn.addEventListener('touchstart', handler);
                    btn.addEventListener('click', handler);
                });
            }
        }

        function createChimneySVG(color) {
            const colors = {
                red: '#c0392b',
                green: '#27ae60',
                blue: '#3498db',
                yellow: '#f1c40f',
                purple: '#8e44ad',
                orange: '#e67e22'
            };
            return `
                <svg viewBox="0 0 100 150" preserveAspectRatio="none" style="width: 100%; height: 90%;">
                    <rect x="10" y="20" width="80" height="130" fill="${colors[color]}" />
                    <rect x="5" y="10" width="90" height="20" fill="#ecf0f1" rx="2" />
                    <rect x="5" y="30" width="90" height="5" fill="rgba(0,0,0,0.2)" />
                </svg>
                <div style="font-size: 3rem;">ğŸ</div>
            `;
        }

        // Combo mode button creation functions
        function updateComboControls(step) {
            const grid = ui.controlsView.querySelector('.controls-grid');
            if (!grid) return;

            grid.innerHTML = '';
            const comboConfig = GAME_MODES.combo;

            if (step === 0) {
                // Show numbers
                grid.className = 'controls-grid grid-5';
                comboConfig.numbers.forEach(numObj => {
                    grid.appendChild(createNumberButton(numObj));
                });
                updateComboStepIndicator(1, 'Choose number');
            } else if (step === 1) {
                // Show colors
                grid.className = 'controls-grid grid-6';
                comboConfig.colors.forEach(colorObj => {
                    grid.appendChild(createColorButton(colorObj));
                });
                updateComboStepIndicator(2, 'Choose color');
            } else if (step === 2) {
                // Show animals (Random 6)
                grid.className = 'controls-grid grid-6';

                // Logic to pick 6 animals including the correct one
                const currentTarget = state.comboSequence[state.playerInputIndex];
                const correctAnimal = currentTarget.animal;

                // Filter out the correct one from the pool
                const otherAnimals = comboConfig.animals.filter(a => a.name !== correctAnimal.name);

                // Shuffle and pick 5
                const shuffledOthers = otherAnimals.sort(() => 0.5 - Math.random()).slice(0, 5);

                // Combine and shuffle again
                const displayAnimals = [correctAnimal, ...shuffledOthers].sort(() => 0.5 - Math.random());

                displayAnimals.forEach(animalObj => {
                    const btn = createAnimalButton(animalObj);
                    btn.classList.add('animal-btn'); // Add class for larger size
                    grid.appendChild(btn);
                });
                updateComboStepIndicator(3, 'Choose animal');
            }
        }

        function createNumberButton(numObj) {
            const btn = document.createElement('button');
            btn.className = 'control-btn';
            btn.setAttribute('data-item', numObj.value);
            btn.setAttribute('data-type', 'number');

            btn.innerHTML = `
                <div class="control-content" style="font-size: 3rem; color: ${numObj.color};">
                    ${numObj.emoji}
                </div>
            `;

            const handler = (e) => {
                e.preventDefault();
                handleComboInput('number', numObj);
            };
            btn.addEventListener('touchstart', handler);
            btn.addEventListener('click', handler);

            return btn;
        }

        function createColorButton(colorObj) {
            const btn = document.createElement('button');
            btn.className = 'control-btn';
            btn.setAttribute('data-item', colorObj.name);
            btn.setAttribute('data-type', 'color');

            btn.innerHTML = `
                <div class="control-content" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <div style="width: 60px; height: 60px; background: ${colorObj.color}; border-radius: 50%; box-shadow: 0 3px 10px rgba(0,0,0,0.3);"></div>
                    <div style="font-size: 1.2rem;">${colorObj.emoji}</div>
                </div>
            `;

            const handler = (e) => {
                e.preventDefault();
                handleComboInput('color', colorObj);
            };
            btn.addEventListener('touchstart', handler);
            btn.addEventListener('click', handler);

            return btn;
        }

        function createAnimalButton(animalObj) {
            const btn = document.createElement('button');
            btn.className = 'control-btn';
            btn.setAttribute('data-item', animalObj.name);
            btn.setAttribute('data-type', 'animal');

            btn.innerHTML = `
                <div class="control-content" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <div style="font-size: 3.5rem;">${animalObj.emoji}</div>
                    <div style="font-size: 1rem; opacity: 0.9;">${animalObj.name}</div>
                </div>
            `;

            const handler = (e) => {
                e.preventDefault();
                handleComboInput('animal', animalObj);
            };
            btn.addEventListener('touchstart', handler);
            btn.addEventListener('click', handler);

            return btn;
        }

        function updateComboStepIndicator(step, text) {
            const indicator = document.getElementById('combo-step-indicator');
            if (indicator) {
                indicator.textContent = `Step ${step}/3: ${text}`;
                if (state.currentMode === 'combo' && !state.isInputLocked) {
                    indicator.classList.add('show');
                } else {
                    indicator.classList.remove('show');
                }
            }
        }

        function createShapeSVG(shape) {
            const colors = { circle: '#e74c3c', square: '#2ecc71', triangle: '#3498db' };
            const color = colors[shape];

            let svgShape = '';
            if (shape === 'circle') {
                svgShape = `<circle cx="50" cy="50" r="40" fill="${color}" />`;
            } else if (shape === 'square') {
                svgShape = `<rect x="15" y="15" width="70" height="70" fill="${color}" rx="5" />`;
            } else if (shape === 'triangle') {
                svgShape = `<path d="M50 10 L90 85 L10 85 Z" fill="${color}" />`;
            }

            return `
                <svg viewBox="0 0 100 100" style="width: 80%; height: 80%;">
                    ${svgShape}
                    <path d="M30 40 Q50 10 70 40" fill="none" stroke="#f1c40f" stroke-width="4" />
                </svg>
            `;
        }

        function createPitchSVG(pitch) {
            const config = {
                low: { note: 'â™©', color: '#e74c3c', bars: 1 },
                mid: { note: 'â™ª', color: '#f39c12', bars: 2 },
                high: { note: 'â™«', color: '#3498db', bars: 3 }
            };
            const { note, color, bars } = config[pitch];

            let barsSVG = '';
            for (let i = 0; i < bars; i++) {
                const height = 30 + (i * 20);
                barsSVG += `<rect x="${20 + i * 25}" y="${70 - height}" width="15" height="${height}" fill="${color}" rx="3" />`;
            }

            return `
                <svg viewBox="0 0 100 100" style="width: 80%; height: 80%;">
                    ${barsSVG}
                </svg>
                <div style="font-size: 2rem; margin-top: 10px;">${note}</div>
            `;
        }

        function createSnow() {
            const count = 50;
            for (let i = 0; i < count; i++) {
                const flake = document.createElement('div');
                flake.classList.add('snowflake');
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.width = flake.style.height = (Math.random() * 10 + 5) + 'px';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                ui.snowContainer.appendChild(flake);
            }
        }

        function setStatus(text) {
            ui.statusText.textContent = text;
            ui.statusText.style.opacity = 1;
        }

        function startRound() {
            if (!state.isPlaying) return;

            state.isInputLocked = true;
            state.playerInputIndex = 0;
            state.sequence = [];
            state.comboSequence = [];
            state.comboStep = 0;
            state.currentComboSelection = {};

            const sequenceLength = state.level;

            if (state.currentMode === 'combo') {
                // Generate random combos
                const comboConfig = GAME_MODES.combo;
                for (let i = 0; i < sequenceLength; i++) {
                    const randomNumber = comboConfig.numbers[Math.floor(Math.random() * comboConfig.numbers.length)];
                    const randomColor = comboConfig.colors[Math.floor(Math.random() * comboConfig.colors.length)];
                    const randomAnimal = comboConfig.animals[Math.floor(Math.random() * comboConfig.animals.length)];
                    state.comboSequence.push({
                        number: randomNumber,
                        color: randomColor,
                        animal: randomAnimal
                    });
                }
            } else {
                // Original mode logic
                const modeConfig = GAME_MODES[state.currentMode];
                for (let i = 0; i < sequenceLength; i++) {
                    const randomItem = modeConfig.items[Math.floor(Math.random() * modeConfig.items.length)];
                    state.sequence.push(randomItem);
                }
            }

            playSequence();
        }

        function playSequence() {
            state.isInputLocked = true;
            setStatus("Listen...");

            let i = 0;

            function showNext() {
                if (state.currentMode === 'combo') {
                    if (i >= state.comboSequence.length) {
                        state.isInputLocked = false;
                        setStatus("Your Turn!");
                        toggleTurnSignal(true); // Green light on
                        ui.bubble.classList.remove('show');
                        updateComboControls(0);  // Show numbers for first selection
                        return;
                    }

                    const combo = state.comboSequence[i];
                    showComboPrompt(combo);
                    audioSys.playCombo(combo.number, combo.color, combo.animal);

                    setTimeout(() => {
                        ui.bubble.classList.remove('show');
                        i++;
                        setTimeout(showNext, 1000);
                    }, 1500);
                } else {
                    if (i >= state.sequence.length) {
                        state.isInputLocked = false;
                        setStatus("Your Turn!");
                        toggleTurnSignal(true); // Green light on
                        ui.bubble.classList.remove('show');
                        return;
                    }

                    const item = state.sequence[i];
                    showPrompt(item);
                    highlightControl(item);
                    audioSys.playItem(item);

                    setTimeout(() => {
                        ui.bubble.classList.remove('show');
                        unhighlightControl(item);
                        i++;
                        setTimeout(showNext, 600);
                    }, 800);
                }
            }

            setTimeout(showNext, 1000);
        }

        function replaySequence() {
            if (state.isPlaying && !state.isInputLocked) {
                // Only allow replay if it's player's turn (input unlocked)
                // Lock input, turn off green light, and play again
                toggleTurnSignal(false);
                playSequence();
            }
        }

        function toggleTurnSignal(active) {
            const signal = document.getElementById('turn-signal');
            if (signal) {
                if (active) signal.classList.add('active');
                else signal.classList.remove('active');
            }
        }

        function showPrompt(item) {
            const mode = state.currentMode;
            const display = GAME_MODES[mode].display[item];

            ui.bubbleContent.innerHTML = '';

            if (mode === 'color') {
                ui.bubbleContent.className = 'prompt-content color-prompt';
                ui.bubbleContent.style.backgroundColor = display.color;
            } else if (mode === 'shape') {
                ui.bubbleContent.className = 'prompt-content';
                let shapeHTML = '';
                if (display.shape === 'circle') {
                    shapeHTML = `<div style="width: 60px; height: 60px; background: ${display.color}; border-radius: 50%;"></div>`;
                } else if (display.shape === 'square') {
                    shapeHTML = `<div style="width: 60px; height: 60px; background: ${display.color}; border-radius: 5px;"></div>`;
                } else {
                    shapeHTML = `<svg width="70" height="70"><path d="M35 5 L70 65 L0 65 Z" fill="${display.color}" /></svg>`;
                }
                ui.bubbleContent.innerHTML = shapeHTML;
            } else if (mode === 'pitch') {
                ui.bubbleContent.className = 'prompt-content';
                ui.bubbleContent.innerHTML = `<div style="font-size: 3.5rem; color: ${display.color}">${display.note}</div>`;
            }

            ui.bubble.classList.add('show');
        }

        function showComboPrompt(combo) {
            ui.bubbleContent.innerHTML = '';
            ui.bubbleContent.className = 'prompt-content combo-display';

            const html = `
                <div class="combo-item">
                    <div class="combo-item-emoji">${combo.number.emoji}</div>
                </div>
                <div class="combo-item">
                    <div class="combo-item-emoji">${combo.color.emoji}</div>
                </div>
                <div class="combo-item">
                    <div class="combo-item-emoji">${combo.animal.emoji}</div>
                </div>
            `;
            ui.bubbleContent.innerHTML = html;
            ui.bubble.classList.add('show');
        }

        function highlightControl(item) {
            const btn = document.querySelector(`[data-item="${item}"]`);
            if (btn) btn.classList.add('active-hint');
        }

        function unhighlightControl(item) {
            const btn = document.querySelector(`[data-item="${item}"]`);
            if (btn) btn.classList.remove('active-hint');
        }

        function handleComboInput(type, obj) {
            if (state.isInputLocked) return;

            // Add visual feedback
            const btn = document.querySelector(`[data-type="${type}"][data-item="${type === 'number' ? obj.value : obj.name}"]`);
            if (btn) {
                btn.classList.add('pop');
                setTimeout(() => btn.classList.remove('pop'), 200);
            }

            // Store selection based on step
            if (state.comboStep === 0) {
                state.currentComboSelection.number = obj;
                audioSys.speak(obj.value.toString()); // Speak number
                state.comboStep = 1;
                updateComboControls(1);  // Show colors
            } else if (state.comboStep === 1) {
                state.currentComboSelection.color = obj;
                audioSys.speak(obj.name); // Speak color
                state.comboStep = 2;
                updateComboControls(2);  // Show animals
            } else if (state.comboStep === 2) {
                state.currentComboSelection.animal = obj;
                audioSys.speak(obj.name); // Speak animal

                // Now validate the whole combo
                const expectedCombo = state.comboSequence[state.playerInputIndex];
                const isCorrect =
                    state.currentComboSelection.number.value === expectedCombo.number.value &&
                    state.currentComboSelection.color.name === expectedCombo.color.name &&
                    state.currentComboSelection.animal.name === expectedCombo.animal.name;

                if (isCorrect) {
                    // Play success sound
                    audioSys.playCorrect();
                    state.playerInputIndex++;

                    // Check if sequence complete
                    if (state.playerInputIndex >= state.comboSequence.length) {
                        handleRoundWin('combo');
                    } else {
                        // Reset for next combo
                        state.comboStep = 0;
                        state.currentComboSelection = {};
                        updateComboControls(0);  // Back to numbers
                        setStatus(`âœ… Good! Next one...`);
                    }
                } else {
                    // Wrong combo
                    handleComboWrong();
                }
            }
        }

        function handleComboWrong() {
            state.isInputLocked = true;
            setStatus("âŒ å†è©¦è©¦ï¼ Try Again!");
            audioSys.playWrong();
            achievements.breakCombo();

            setTimeout(() => {
                state.playerInputIndex = 0;
                state.comboStep = 0;
                state.currentComboSelection = {};
                playSequence();
            }, 2000);
        }

        function handleInput(item) {
            if (state.isInputLocked) return;

            const btn = document.querySelector(`[data-item="${item}"]`);
            btn.classList.add('pop');
            setTimeout(() => btn.classList.remove('pop'), 200);

            const expectedItem = state.sequence[state.playerInputIndex];

            if (item === expectedItem) {
                audioSys.playItem(item);
                state.playerInputIndex++;

                if (state.playerInputIndex >= state.sequence.length) {
                    handleRoundWin(item);
                }
            } else {
                handleWrong(item);
            }
        }

        function handleRoundWin(lastItem) {
            state.isInputLocked = true;
            setStatus("âœ… æ£’ï¼ Good Job!");

            // Exciting Reward Sound!
            audioSys.playWin();

            santaAnim.nod();
            achievements.addStar();

            // For combo mode, find the last clicked button differently
            let btn;
            if (lastItem === 'combo') {
                // In combo mode, just find any visible button for effect position
                btn = document.querySelector('.control-btn');
            } else {
                btn = document.querySelector(`[data-item="${lastItem}"]`);
            }

            if (btn) {
                const rect = btn.getBoundingClientRect();
                // Character-specific effects!
                createCharacterEffect(rect.left + rect.width / 2, rect.top + rect.height / 2);
                createSparkles(rect.left + rect.width / 2, rect.top + rect.height / 2);
            } else {
                // Fallback: center of screen
                createCharacterEffect(window.innerWidth / 2, window.innerHeight / 2);
                createSparkles(window.innerWidth / 2, window.innerHeight / 2);
            }

            state.score++;
            updateScoreboard();

            if (state.score >= state.maxScore) {
                // Level Completed! Show Next Level button
                setTimeout(() => {
                    const btn = document.getElementById('next-level-btn');
                    if (btn) {
                        btn.style.display = 'block';
                        audioSys.speak("Next Level!");
                    }
                    handleLevelUpEffectOnly();
                }, 1500);
            } else {
                // Just next round
                setTimeout(startRound, 2000);
            }
        }

        function handleLevelUpEffectOnly() {
            audioSys.playWin();
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createFirework(
                        Math.random() * window.innerWidth,
                        Math.random() * (window.innerHeight * 0.6)
                    );
                }, i * 200);
            }
        }

        function nextLevel() {
            const btn = document.getElementById('next-level-btn');
            if (btn) btn.style.display = 'none';

            state.level++;
            if (state.level > 5) state.level = 1; // Loop back

            state.score = 0; // Reset score for new level
            updateScoreboard();

            startRound();
        }

        function handleWrong(item) {
            state.isInputLocked = true;
            setStatus("âŒ å†è©¦è©¦ï¼ Try Again!");
            audioSys.playWrong();
            achievements.breakCombo();

            const btn = document.querySelector(`[data-item="${item}"]`);
            btn.classList.add('shake');
            setTimeout(() => btn.classList.remove('shake'), 500);

            setTimeout(() => {
                state.playerInputIndex = 0;
                playSequence();
            }, 2000);
        }

        function handleLevelUp() {
            audioSys.playWin();

            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createFirework(
                        Math.random() * window.innerWidth,
                        Math.random() * (window.innerHeight * 0.6)
                    );
                }, i * 200);
            }

            state.level++;
            ui.levelUpText.textContent = "Level " + state.level + "!";
            ui.levelUpOverlay.classList.add('show');

            setTimeout(() => {
                ui.levelUpOverlay.classList.remove('show');
                state.score = 0;
                updateScoreboard();
                startRound();
            }, 4000);
        }

        function updateScoreboard() {
            ui.levelDisplay.textContent = "Level " + state.level;
            let stars = '';
            for (let i = 0; i < state.maxScore; i++) {
                stars += i < state.score ? 'â­' : 'â˜†';
            }
            ui.scoreboard.textContent = stars;
        }

        function createFirework(x, y) {
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const el = document.createElement('div');
            el.classList.add('firework');
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.backgroundColor = color;
            el.style.boxShadow = `0 0 20px ${color}`;
            el.style.animation = 'fireworks 1s ease-out forwards';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // Character-specific effects!
        function createCharacterEffect(x, y) {
            const effects = {
                'santa': 'ğŸ', // Santa throws gifts
                'snowman': 'â›„', // Snowman throws snowballs  
                'reindeer': 'ğŸ’©' // Reindeer poops (funny for kids!)
            };

            const emoji = effects[selectedCharacter] || 'ğŸ';

            // Create MORE and BIGGER effects!
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.textContent = emoji;
                    particle.style.position = 'fixed';
                    particle.style.fontSize = '3rem'; // BIGGER!
                    particle.style.pointerEvents = 'none';
                    particle.style.zIndex = '9999';

                    const angle = (Math.PI * 2 * i) / 8 + Math.random() * 0.3;
                    const distance = 120 + Math.random() * 60; // FURTHER!
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance - 80; // More upward

                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.transition = 'all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'; // SLOWER!
                    particle.style.opacity = '1';

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        particle.style.transform = `translate(${tx}px, ${ty}px) rotate(${Math.random() * 720}deg)`;
                        particle.style.opacity = '0';
                    }, 10);

                    setTimeout(() => particle.remove(), 1600);
                }, i * 80);
            }
        }

        function createSparkles(x, y) {
            for (let i = 0; i < 12; i++) {
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');

                const angle = (Math.PI * 2 * i) / 12;
                const distance = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                sparkle.style.setProperty('--tx', tx + 'px');
                sparkle.style.setProperty('--ty', ty + 'px');

                document.body.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 600);
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        init();

    </script>
</body>

</html>